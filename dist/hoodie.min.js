// Hoodie.js - 0.4.0
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

!function(){"use strict";function a(c){var d=this;if(!(d instanceof a))throw new Error("usage: new Hoodie(url);");c&&(this.baseUrl=c.replace(/\/+$/,"")),this.extend=function(a){a(d)},this.bind=L.bind,this.on=L.on,this.one=L.one,this.trigger=L.trigger,this.unbind=L.unbind,this.off=L.off,this.defer=M.defer,this.isPromise=M.isPromise,this.resolve=M.resolve,this.reject=M.reject,this.resolveWith=M.resolveWith,this.request=N,this.isOnline=O.isOnline,this.checkConnection=O.checkConnection,this.UUID=P,this.dispose=Q,this.open=R,this.store=S,this.task=T,this.config=U,this.account=V,this.remote=W,this.account.username=U.get("_account.username"),this.account.checkPasswordReset(),this.on("account:signout",U.clear),this.store.patchIfNotPersistant(),this.store.subscribeToOutsideEvents(),this.store.bootstrapDirtyObjects(),this.remote.subscribeToEvents(),this.task.subscribeToStoreEvents(),this.account.authenticate().then(function(){W.connect()}),window.addEventListener("online",this.checkConnection,!1),window.addEventListener("offline",this.checkConnection,!1),this.checkConnection(),b(d)}function b(a){for(var b=0;b<X.length;b++)X[b](a)}function c(a){var b="function"==typeof a.done,c="function"!=typeof a.resolve;return!!(a&&b&&c)}function d(){return Z.resolve().promise()}function e(){return Z.reject().promise()}function f(){return Z.resolve.apply(Z,arguments).promise()}function g(){return Z.reject.apply(Z,arguments).promise()}function h(){return _=3e4,bb=window.setTimeout(exports.checkConnection,_),exports.isConnected()||(L.trigger("reconnected"),$=!0),M.resolve()}function i(){return _=3e3,bb=window.setTimeout(exports.checkConnection,_),exports.isConnected()&&(L.trigger("disconnected"),$=!1),M.reject()}function j(a){return U.set(sb,a)}function k(){return U.get(sb)}function l(){return U.unset(sb)}function m(a){return V.username!==a?(V.username=a,U.set("_account.username",a)):void 0}function n(a){return V.ownerHash!==a?(V.ownerHash=a,U.set("createdBy",a),U.set("_account.ownerHash",a)):void 0}function o(a){return a.userCtx.name?(ob=!0,m(a.userCtx.name.replace(/^user(_anonymous)?\//,"")),n(a.userCtx.roles[0]),M.resolveWith(V.username)):V.hasAnonymousAccount()?V.signIn(V.username,k()):(ob=!1,V.trigger("error:unauthenticated"),M.reject())}function p(a){var b;if(a=a||{},a.reason)return M.rejectWith(a);var c=a;try{a=JSON.parse(c.responseText)}catch(d){b=d,a={error:c.responseText||"unknown"}}return M.rejectWith(a)}function q(a,b){return function(c){return V.trigger("signup",a),pb._rev=c.rev,r(a,b)}}function r(a,b,c,d){return d||(d=M.defer()),window.setTimeout(function(){var e=J(a,b);e.done(d.resolve),e.fail(function(e){"unconfirmed"===e.error?r(a,b,c,d):d.reject.apply(d,arguments)})},300),d.promise()}function s(a){return a=a||{},function(b){var c,d;return c=M.defer(),d=b.name.replace(/^user(_anonymous)?\//,""),-1!==b.roles.indexOf("error")?(V.fetch(d).fail(c.reject).done(function(){return c.reject({error:"error",reason:pb.$error})}),c.promise()):-1===b.roles.indexOf("confirmed")?c.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(m(d),n(b.roles[0]),ob=!0,a.silent||a.reauthenticated||(V.hasAnonymousAccount()?V.trigger("signin:anonymous",d):V.trigger("signin",d)),a.reauthenticated&&V.trigger("reauthenticated",d),V.fetch(),c.resolve(d,b.roles[0]))}}function t(a){var b;return b=a.$error?a.$error:{error:"pending"},M.rejectWith(b)}function u(a){return 401===a.status?(U.unset("_account.resetPasswordId"),V.trigger("passwordreset"),M.resolve()):p(a)}function v(a,b,c){return J(V.username,a,{silent:!0}).then(function(){return V.fetch().then(E(a,b,c))})}function w(a,b){var c=k();return v(c,a,b).done(function(){V.trigger("signup",a),l()})}function x(){return W.disconnect(),pb._deleted=!0,G("updateUsersDoc",function(){V.request("PUT",D(),{data:JSON.stringify(pb),contentType:"application/json"})})}function y(a){return"not_found"===a.error?M.resolve():M.rejectWith(a)}function z(a){return a=a||{},V.trigger("cleanup"),ob=a.authenticated,U.clear(),m(a.username),n(a.ownerHash||jb()),M.resolve()}function A(){return z().then(function(){return V.trigger("signout")})}function B(a){var b;return b=a===V.ownerHash?"user_anonymous":"user",""+b+"/"+a}function C(a){return a=a||V.username,""+rb+":"+B(a)}function D(a){return"/_users/"+encodeURIComponent(C(a))}function E(a,b,c){return function(){var d=eb.extend({},pb);b&&(d.$newUsername=b),d.updatedAt=K(),d.signedUpAt=d.signedUpAt||K(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return G("updateUsersDoc",function(){return V.request("PUT",D(),e).then(F(b,c||a),p)})}}function F(a,b){return function(){return W.disconnect(),a?r(a,b,{silent:!0}):V.signIn(V.username,b)}}function G(a,b){return void 0!==qb[a]&&"function"==typeof qb[a].abort&&qb[a].abort(),qb[a]=b(),qb[a]}function H(a,b){return void 0!==qb[a]&&"function"==typeof qb[a].state&&"pending"===qb[a].state()?qb[a]:(qb[a]=b(),qb[a])}function I(){return H("signOut",function(){return V.request("DELETE","/_session").then(null,p)})}function J(a,b,c){var d={data:{name:B(a),password:b}};return G("signIn",function(){var a=V.request("POST","/_session",d);return a.then(s(c),p)})}function K(){return new Date}var L=require("./hoodie/events"),M=require("./hoodie/promises"),N=require("./hoodie/request"),O=require("./hoodie/connection"),P=require("./hoodie/uuid"),Q=require("./hoodie/dispose"),R=require("./hoodie/open"),S=require("./hoodie/store"),T=require("./hoodie/task"),U=require("./hoodie/config"),V=require("./hoodie/account"),W=require("./hoodie/remote_store"),V=require("./hoodie/account"),X=[];a.extend=function(a){X.push(a)},module.exports=a,window.Hoodie=a;var Y=require("../hoodie");module.exports=function(a){function b(a,b){var c,d,e,f;for(c=a.split(" "),e=0,f=c.length;f>e;e++)d=g+c[e],Y.eventsCallbacks[d]=Y.eventsCallbacks[d]||[],Y.eventsCallbacks[d].push(b)}function c(a,b){a=g+a;var c=function(){exports.unbind(a,c),b.apply(null,arguments)};exports.bind(a,c)}function d(){var a,b,c,d,e,f;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),c=g+c,d=Y.eventsCallbacks[c]){for(e=0,f=d.length;f>e;e++)b=d[e],b.apply(null,a);return!0}}function e(a,b){var c,d,e,f,h,i;if(!a)return g||(Y.eventsCallbacks={}),i=Object.keys(Y.eventsCallbacks),i=i.filter(function(a){return 0===a.indexOf(g)}),i.forEach(function(a){delete Y.eventsCallbacks[a]}),void 0;if(a=g+a,e=Y.eventsCallbacks[a]){if(!b)return delete Y.eventsCallbacks[a],void 0;for(d=f=0,h=e.length;h>f;d=++f)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),Y.eventsCallbacks[a]=e;break}}}var f=Y,g="";return a=a||{},Y.eventsCallbacks||(Y.eventsCallbacks={}),a.context&&(f=a.context,g=a.namespace+":"),{bind:b,on:b,one:c,trigger:d,unbind:e,off:e}};var Z=eb.Deferred();module.exports={defer:Z,isPromise:c,resolve:d,reject:e,resolveWith:f,rejectWith:g};var M=require("./promises");module.exports=function(){function a(a,f,g){var h,i,j;return g=g||{},h={type:a,dataType:"json"},/^http/.test(f)||(f=(this.baseUrl||"")+e+f),/^http/.test(f)&&(h.xhrFields={withCredentials:!0},h.crossDomain=!0),h.url=f,i=d(c(h,g)),j=i.then(null,b),j.abort=i.abort,j}function b(a){var b;try{b=JSON.parse(a.responseText)}catch(c){b={error:a.responseText||"Cannot connect to Hoodie server at "+(this.baseUrl||"/")}}return M.rejectWith(b).promise()}var c=eb.extend,d=eb.ajax,e="/_api";return a};var M=require("./promises"),L=require("./events"),N=require("./request"),$=!0,_=3e4,ab=null,bb=null,cb=function(){var a=ab;return a&&"pending"===a.state()?a:(window.clearTimeout(bb),ab=N("GET","/").then(h,i))},db=function(){return $};module.exports={checkConnection:cb,isConnected:db},module.exports=function(a){var b,c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=c.length,e="";for(void 0===a&&(a=7),b=0;a>b;b++){var f=Math.random()*d,g=c[Math.floor(f)];e+=String(g).charAt(0)}return e};var L=require("./events");module.exports=function(){L.trigger("dispose"),L.unbind()};var eb=require("jQuery"),fb=require("./store");module.exports=function(){function a(a,c){return c=c||{},b(c,{name:a}),fb(c)}var b=eb.extend;return a};var Y=require("../hoodie"),L=require("./events"),gb=require("./scoped_store"),hb=require("./errors"),ib=require("util");module.exports=function(a){function b(a){return new RegExp(/^[^\/]+$/).test(a||"")}function c(a){return new RegExp(/^[^\/]+$/).test(a||"")}function d(a){return ib.inherits(a,i)}function e(){var a=Y.resolveWith.apply(null,arguments);return d(a)}function f(){var a=Y.rejectWith.apply(null,arguments);return d(a)}var g,h={},i={hoodie:Y};g=a?a.name||"store":"store";var j=function l(b,c){var d=eb.extend(!0,{type:b,id:c},a);return gb(l,d)};if(L({context:j,namespace:g}),j.validate=function(a){return a.id?a?c(a.type)?b(a.id)?void 0:hb.INVALID_KEY({id:a.id}):hb.INVALID_KEY({type:a.type}):hb.INVALID_ARGUMENTS("no object passed"):void 0},j.save=function(a,b,c,e){e=e?eb.extend(!0,{},e):{};var g=eb.extend(!0,{},c,{type:a,id:b}),i=j.validate(g,e||{});return i?f(i):d(h.save(g,e||{}))},j.add=function(a,b,c){return b=b||{},c=c||{},j.save(a,b.id,b,c)},j.find=function(a,b){return d(h.find(a,b))},j.findOrAdd=function(a,b,c){function e(){var d=eb.extend(!0,{id:b},c);return j.add(a,d)}c=c||{};var f=j.find(a,b).then(null,e);return d(f)},j.findAll=function(a,b){return d(h.findAll(a,b))},j.update=function(a,b,c,f){function g(d){var g,h,i;return h=eb.extend(!0,{},d),"function"==typeof c&&(c=c(h)),c?(g=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(i=c[b],d[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),g.length||f?j.save(a,b,h,f):e(h)):e(d)}var h=j.find(a,b).then(g);return d(h)},j.updateOrAdd=function(a,b,c,e){function f(){var d=eb.extend(!0,{},c,{id:b});return j.add(a,d,e)}var g=j.update(a,b,c,e).then(null,f);return d(g)},j.updateAll=function(a,b,c){var e;switch(c=c||{},!0){case"string"==typeof a:e=j.findAll(a);break;case Y.isPromise(a):e=a;break;case eb.isArray(a):e=Y.defer().resolve(a).promise();break;default:e=j.findAll()}return e=e.then(function(a){var d,e;return eb.isArray(a)||(a=[a]),e=function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)d=a[e],g.push(j.update(d.type,d.id,b,c));return g}(),eb.when.apply(null,e)}),d(e)},j.remove=function(a,b,c){return d(h.remove(a,b,c||{}))},j.removeAll=function(a,b){return d(h.removeAll(a,b||{}))},j.decoratePromises=function(a){return ib.inherits(i,a)},!a.backend)throw new Error("options.backend must be passed");var k="save find findAll remove removeAll".split(" ");return k.forEach(function(b){if(!a.backend[b])throw new Error("options.backend."+b+" must be passed.");h[b]=a.backend[b]}),j}();var S=require("./store"),L=require("./events");module.exports=function(a,b){var c=b.name||"store",d=b.type,e=b.id,f={};return e||(L({context:f,namespace:c+":"+d}),f.save=function(a,b,c){return S.save(d,a,b,c)},f.add=function(a,b){return S.add(d,a,b)},f.find=function(a){return S.find(d,a)},f.findOrAdd=function(a,b){return S.findOrAdd(d,a,b)},f.findAll=function(a){return S.findAll(d,a)},f.update=function(a,b,c){return S.update(d,a,b,c)},f.updateAll=function(a,b){return S.updateAll(d,a,b)},f.remove=function(a,b){return S.remove(d,a,b)},f.removeAll=function(a){return S.removeAll(d,a)}),e&&(L({context:f,namespace:c+":"+d+":"+e}),f.save=function(a,b){return S.save(d,e,a,b)},f.find=function(){return S.find(d,e)},f.update=function(a,b){return S.update(d,e,a,b)},f.remove=function(a){return S.remove(d,e,a)}),f.decoratePromises=S.decoratePromises,f.validate=S.validate,f},module.exports={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}};var jb=require("./uuid"),O=require("./connection"),M=require("./promises"),N=require("./request"),fb=require("./store");module.exports=function(a){function b(a){return"function"==typeof r?r(a):r=a}function c(a){var b,c;c=eb.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==x.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,p.prefix&&(c._id=""+p.prefix+c._id),delete c.id,c}function d(a){var b,c,d;return b=a._id||a.id,delete a._id,p.prefix&&(b=b.replace(new RegExp("^"+p.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function e(a){var b,c,e,f;for(f=[],c=0,e=a.length;e>c;c++)b=a[c],f.push(d(b));return f}function f(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=g(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function g(){return jb(9)}function h(a){return a.rows.map(function(a){return a.doc})}function i(){var a;return a=p.getSinceNr(),p.isConnected()&&!s?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function j(){t&&t.abort()}function k(a){return b(a.last_seq),n(a.results),p.isConnected()?p.pull():void 0}function l(a,b){if(p.isConnected())switch(a.status){case 401:return p.trigger("error:unauthenticated",b),p.disconnect();case 404:return window.setTimeout(p.pull,3e3);case 500:return p.trigger("error:server",b),window.setTimeout(p.pull,3e3),O.checkConnection();default:return"abort"===a.statusText?p.pull():(window.setTimeout(p.pull,3e3),O.checkConnection())}}function m(){s=!1,p.trigger("bootstrap:end")}function n(a){var b,c,e,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!p.prefix||0===b._id.indexOf(p.prefix)){if(e=d(b),e._deleted){if(!p.isKnownObject(e))continue;c="remove",p.isKnownObject(e)}else p.isKnownObject(e)?c="update":(c="add",p.markAsKnownObject(e));p.trigger(c,e),p.trigger(c+":"+e.type,e),p.trigger(c+":"+e.type+":"+e.id,e),p.trigger("change",c,e),p.trigger("change:"+e.type,c,e),p.trigger("change:"+e.type+":"+e.id,c,e)}}var o={};o.find=function(a,b){var c;return c=a+"/"+b,p.prefix&&(c=p.prefix+c),c="/"+encodeURIComponent(c),N("GET",c).then(d)},o.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==p.prefix:d=p.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==p.prefix:d=p.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),N("GET",c).then(h).then(e)},o.save=function(a){var b;return a.id||(a.id=jb()),a=c(a),b="/"+encodeURIComponent(a._id),N("PUT",b,{data:a})},o.remove=function(a,b){return p.update(a,b,{_deleted:!0})},o.removeAll=function(a){return p.updateAll(a,{_deleted:!0})};var p=fb({name:a.name,backend:{save:o.save,find:o.find,findAll:o.findAll,remove:o.remove,removeAll:o.removeAll}}),q=null;p.connected=!1,p.prefix="",void 0!==a.name&&(q=a.name),void 0!==a.prefix&&(p.prefix=a.prefix),null!==a.baseUrl&&(p.baseUrl=a.baseUrl),N=function A(a,b,c){return c=c||{},q&&(b="/"+encodeURIComponent(q)+b),p.baseUrl&&(b=""+p.baseUrl+b),c.contentType=c.contentType||"application/json",("POST"===a||"PUT"===a)&&(c.dataType=c.dataType||"json",c.processData=c.processData||!1,c.data=JSON.stringify(c.data)),A(a,b,c)},p.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==w[b]?w[b]:void 0},p.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return w[b]=1,w[b]},p.connect=function(a){return a&&(q=a),p.connected=!0,p.trigger("connect"),p.bootstrap()},p.disconnect=function(){p.connected=!1,p.trigger("disconnect"),t&&t.abort(),v&&v.abort()},p.isConnected=function(){return p.connected};var r=a.since||0;p.getSinceNr=function(){return"function"==typeof r?r():r};var s=!1;p.bootstrap=function(){return s=!0,p.trigger("bootstrap:start"),p.pull().done(m)};var t,u;p.pull=function(){return t=N("GET",i()),p.isConnected()&&(window.clearTimeout(u),u=window.setTimeout(j,25e3)),t.done(k).fail(l)};var v;p.push=function(a){var b,d,e,g;if(eb.isArray(a)||(a=y()),0===a.length)return M.resolveWith([]);for(d=[],e=0,g=a.length;g>e;e++)b=eb.extend(!0,{},a[e]),f(b),b=c(b),d.push(b);return v=N("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),v.done(function(){for(var b=0;b<a.length;b++)p.trigger("push",a[b])}),v},p.sync=function(a){return p.push(a).then(p.pull)};var w={},x=["_id","_rev","_deleted","_revisions","_attachments"],y=function(){return[]};if(a.defaultObjectsToPush&&(y=eb.isArray(a.defaultObjectsToPush)?function(){return a.defaultObjectsToPush}:a.defaultObjectsToPush),a.knownObjects)for(var z=0;z<a.knownObjects.length;z++)p.markAsKnownObject({type:a.knownObjects[z].type,id:a.knownObjects[z].id});return p};var jb=require("./uuid"),V=require("./account"),M=require("./promises"),L=require("./events"),hb=require("./errors"),kb=require("./store");module.exports=function(){function a(a){return o(a.type)?arguments.length>0&&!n(a.id)?hb.INVALID_KEY({id:a.id}):void 0:hb.INVALID_KEY({type:a.type})}function b(a,b,c,d){var g;if(void 0===c&&(c=!1),d=d||{},g=""+a+"/"+b,c){if(eb.extend(c,{type:a,id:b}),j(a,b,c),d.remote)return f(a,b),z[g]=eb.extend(!0,{},c),z[g]}else{if(z[g]===!1)return!1;if(z[g])return eb.extend(!0,{},z[g]);if(c=k(a,b),c===!1)return f(a,b),z[g]=!1,!1}return r(c)?(e(a,b,c,d),z[g]=!1,!1):(z[g]=eb.extend(!0,{},c),q(c)?e(a,b,z[g],d):f(a,b),eb.extend(!0,{},c))}function c(){var a,c,d,e,f,g,h;if(c=F.getItem("_dirty"))for(c=c.split(","),f=0,g=c.length;g>f;f++)h=c[f].split("/"),e=h[0],a=h[1],d=b(e,a)}function d(){L.on("account:cleanup",D.clear),L.on("account:signup",g),L.on("remote:bootstrap:start",u),L.on("remote:bootstrap:end",v),L.on("remote:change",h),L.on("remote:push",i)}function e(a,b,c,d){var e;d=d||{},e=""+a+"/"+b,A[e]=c,l(),d.silent||t()}function f(a,b){var c;return a&&b?(c=""+a+"/"+b,delete A[c]):A={},l(),window.clearTimeout(G)}function g(){return D.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,A[b]=c;l(),t()})}function h(a,b){"remove"===a?D.remove(b.type,b.id,{remote:!0}):D.save(b.type,b.id,b,{remote:!0})}function i(a){s("sync",a)}function j(a,b,c){var d,e;return d=""+a+"/"+b,e=eb.extend({},c),delete e.type,delete e.id,F.setItem(d,JSON.stringify(e))}function k(a,b){var c,d;c=""+a+"/"+b;var e=F.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function l(){try{if(eb.isEmptyObject(A))F.removeItem("_dirty");else{var a=Object.keys(A);F.setItem("_dirty",a.join(","))}}catch(b){}}function m(){return JSON.stringify(new Date).replace(/['"]/g,"")}function n(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)}function o(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)}function p(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)}function q(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function r(a){return a._deleted===!0}function s(a,b,c){D.trigger(a,b,c),D.trigger(""+a+":"+b.type,b,c),"new"!==a&&D.trigger(""+a+":"+b.type+":"+b.id,b,c),"sync"!==a&&(D.trigger("change",a,b,c),D.trigger("change:"+b.type,a,b,c),"new"!==a&&D.trigger("change:"+b.type+":"+b.id,a,b,c))}function t(){D.trigger("dirty"),window.clearTimeout(G),G=window.setTimeout(function(){D.trigger("idle",D.changedObjects())},C)}function u(){E=!0,D.trigger("bootstrap:start")}function v(){var a,b,c,d;for(E=!1;B.length>0;)a=B.shift(),b=a[0],c=a[1],d=a[2],y[b].apply(y,c).then(d.resolve,d.reject);D.trigger("bootstrap:end")}function w(a,b){var c=M.defer();return B.push([a,b,c]),c.promise()}function x(){D.isPersistent()||(F={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var y={},z={},A={},B=[],C=2e3;y.save=function(a,c){var d,e,f,g,h,i;if(c=c||{},D.isBootstrapping())return w("save",arguments);if(a.id?(d=b(a.type,a.id),h="object"!=typeof d):(h=!0,a.id=jb()),h?a.createdBy=a.createdBy||V.ownerHash:d.createdBy&&(a.createdBy=d.createdBy),!h)for(i in d)if(!a.hasOwnProperty(i))switch(i.charAt(0)){case"_":c.remote&&(a[i]=d[i]);break;case"$":c.remote||(a[i]=d[i])}c.remote?a._syncedAt=m():c.silent||(a.updatedAt=m(),a.createdAt=a.createdAt||a.updatedAt),c.local?a._$local=!0:delete a._$local,e=M.defer();try{a=b(a.type,a.id,a,c),e.resolve(a,h).promise(),g=h?"add":"update",s(g,a,c)}catch(j){f=j,e.reject(f.toString())}return e.promise()},y.find=function(a,c){var d,e,f;if(d=M.defer(),D.isBootstrapping())return w("find",arguments);try{f=b(a,c),f||d.reject(hb.NOT_FOUND(a,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return d.promise()},y.findAll=function(a){var c,d,e,f,g,h,i,j,k;if(null==a&&(a=function(){return!0}),D.isBootstrapping())return w("findAll",arguments);h=D.index(),"string"==typeof a&&(k=a,a=function(a){return a.type===k}),d=M.defer();try{j=function(){var d,e,j,k;for(k=[],d=0,e=h.length;e>d;d++)g=h[d],p(g)&&(j=g.split("/"),c=j[0],f=j[1],i=b(c,f),i&&a(i)&&k.push(i));return k}.call(this),j.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(j).promise()}catch(l){e=l,d.reject(e).promise()}return d.promise()},y.remove=function(a,c,d){var e,g,h;return d=d||{},D.isBootstrapping()?w("remove",arguments):(e=a+"/"+c,g=b(a,c),d.remote&&(F.removeItem(e),h=z[e]&&r(z[e]),z[e]=!1,f(a,c),h&&g)?M.resolveWith(g):g?(g._syncedAt?(g._deleted=!0,b(a,c,g)):(e=a+"/"+c,F.removeItem(e),z[e]=!1,f(a,c)),s("remove",g,d),M.resolveWith(g)):M.rejectWith(hb.NOT_FOUND(a,c)))},y.removeAll=function(a,b){return D.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(D.remove(c.type,c.id,b));return f})};var D=kb({validate:a,backend:{save:y.save,find:y.find,findAll:y.findAll,remove:y.remove,removeAll:y.removeAll}});D.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=F.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=F.key(a),p(b)&&c.push(b);return c},D.changedObjects=function(){var a,b,c,d,e,f,g;e=A,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},D.hasLocalChanges=function(a,c){if(!a)return!eb.isEmptyObject(A);var d=[a,c].join("/");return A[d]?!0:q(b(a,c))},D.clear=function(){var a,b,c,d;a=M.defer();try{c=D.index(),d=function(){var a,d,e;for(e=[],a=0,d=c.length;d>a;a++)b=c[a],p(b)&&e.push(F.removeItem(b));return e}.call(this),z={},f(),a.resolve(),D.trigger("clear")}catch(e){a.reject(e)}return a.promise()};var E=!1;D.isBootstrapping=function(){return E},D.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var F={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};D.subscribeToOutsideEvents=function(){d(),delete D.subscribeToOutsideEvents};var G;D=kb,D.bootstrapDirtyObjects=function(){c(),delete D.bootstrapDirtyObjects},D.patchIfNotPersistant=function(){x(),delete D.patchIfNotPersistant}};var S=require("./store"),lb="$config",mb="hoodie",nb={},U={};U.set=function(a,b){var c,d;if(nb[a]!==b)return nb[a]=b,d={},d[a]=b,c="_"===a.charAt(0),S.updateOrAdd(lb,mb,d,{silent:c})},U.get=function(a){return nb[a]},U.clear=function(){return nb={},S.remove(lb,mb)},U.unset=function(a){return U.set(a,void 0)},S.find(lb,mb).done(function(a){nb=a}),module.exports=U;var ob,L=require("./events"),M=require("./promises"),jb=require("./uuid"),U=require("./config"),W=require("./remote_store"),V={},pb={},qb={},rb="org.couchdb.user";L({context:V,namespace:"account"}),V.authenticate=function(){var a;return ob===!1?M.reject():ob===!0?M.resolveWith(V.username):qb.signOut&&"pending"===qb.signOut.state()?qb.signOut.then(M.rejectWith):qb.signIn&&"pending"===qb.signIn.state()?qb.signIn:void 0===V.username?I().then(function(){return ob=!1,M.reject()}):(a=function(){return V.request("GET","/_session").then(o,p)},H("authenticate",a))},V.signUp=function(a,b){if(void 0===b&&(b=""),!a)return M.rejectWith({error:"username must be set"});if(V.hasAnonymousAccount())return w(a,b);if(V.hasAccount())return M.rejectWith({error:"you have to sign out first"});a=a.toLowerCase();var c={data:JSON.stringify({_id:C(a),name:B(a),type:"user",roles:[],password:b,ownerHash:V.ownerHash,database:V.db(),updatedAt:K(),createdAt:K(),signedUpAt:a!==V.ownerHash?K():void 0}),contentType:"application/json"};return V.request("PUT",D(a),c).then(q(a,b),p)},V.anonymousSignUp=function(){var a=jb(10),b=V.ownerHash;return V.signUp(b,a).done(function(){return j(a),V.trigger("signup:anonymous",b)})},V.hasAccount=function(){return!!V.username},V.hasAnonymousAccount=function(){return void 0!==k()};var sb="_account.anonymousPassword";V.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==V.username?V.signOut({silent:!0}).then(function(){return J(a,b)}):J(a,b,{reauthenticated:!0})},V.signOut=function(a){return a=a||{},V.hasAccount()?(W.disconnect(),I().then(A)):z().then(function(){return a.silent?void 0:V.trigger("signout")})},V.request=function ub(a,b,c){return c=c||{},ub.apply(arguments)},V.db=function(){return"user/"+V.ownerHash},V.fetch=function(a){return void 0===a&&(a=V.username),a?H("fetch",function(){return V.request("GET",D(a)).then(null,p).done(function(a){return pb=a})}):M.rejectWith({error:"unauthenticated",reason:"not logged in"})},V.changePassword=function(a,b){return V.username?(W.disconnect(),V.fetch().then(E(a,null,b),p)):M.rejectWith({error:"unauthenticated",reason:"not logged in"})},V.resetPassword=function(a){var b,c,d,e;return(e=U.get("_account.resetPasswordId"))?V.checkPasswordReset():(e=""+a+"/"+jb(),U.set("_account.resetPasswordId",e),c=""+rb+":$passwordReset/"+e,b={_id:c,name:"$passwordReset/"+e,type:"user",roles:[],password:e,createdAt:K(),updatedAt:K()},d={data:JSON.stringify(b),contentType:"application/json"},G("resetPassword",function(){return V.request("PUT","/_users/"+encodeURIComponent(c),d).then(null,p).done(V.checkPasswordReset)}))},V.checkPasswordReset=function(){var a,b,c,d,e;return(c=U.get("_account.resetPasswordId"))?(e="$passwordReset/"+c,d="/_users/"+encodeURIComponent(rb+":"+e),a=btoa(e+":"+c),b={headers:{Authorization:"Basic "+a}},G("passwordResetStatus",function(){return V.request("GET",d,b).then(t,u).fail(function(a){return"pending"===a.error?(window.setTimeout(V.checkPasswordReset,1e3),void 0):V.trigger("password_reset:error")})})):M.rejectWith({error:"missing"})},V.changeUsername=function(a,b){return b=b||"",v(a,b.toLowerCase())},V.destroy=function(){return V.hasAccount()?V.fetch().then(x,y).then(A):A()},V.ownerHash=U.get("_account.ownerHash"),V.ownerHash||n(jb()),module.exports=V;var R=require("./open"),V=require("./account"),S=require("./store"),L=require("./events"),U=require("./config");module.exports=function(){function a(a){return a?U.set("_remote.since",a):U.get("_remote.since")||0}function b(){L.on("remote:connect",function(){L.on("store:idle",c.push),c.push()}),L.on("remote:disconnect",function(){L.unbind("store:idle",c.push)}),L.on("disconnected",c.disconnect),L.on("reconnected",c.connect),L.on("account:signin",function(){c.connect(V.db())}),L.on("account:reauthenticated",c.connect),L.on("account:signout",c.disconnect)}var c=R(V.db(),{connected:!0,prefix:"",since:a,defaultObjectsToPush:S.changedObjects,knownObjects:S.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})});return c.trigger=function(){var a;a=arguments[0];var b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return L.trigger.apply(["remote:"+a].concat(Array.prototype.slice.call(b)))},c.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),L.on(a,b)},c.unbind=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),L.unbind(a,b)},c.subscribeToEvents=function(){b(),delete c.subscribeToEvents},c};var L=require("./events"),M=require("./promises"),tb=require("./scoped_task"),V=require("./account"),S=require("./store");module.exports=function(){function a(){L.on("store:change",d)}function b(a){var b=M.defer(),c=S(a.type,a.id);return c.on("remove",function(a){return a.type=a.type.substr(1),a.finishedAt?b.resolve(a):(b.reject(a),void 0)}),c.on("error",function(a,c){c.type=c.type.substr(1),b.reject(a,c)}),b.promise()}function c(a){var b,c="$"+a.type,d=a.id,e=S.remove(c,d);return a._rev?(b=M.defer(),L.one("store:sync:"+c+":"+d,b.resolve),e.fail(b.reject),b.promise()):e}function d(a,b,c){"$"===b.type[0]&&(b.type=b.type.substr(1),h(a,b,c))}function e(a){var b,c="$";return a&&(c+=a),b=function(a){return 0===a.type.indexOf(c)},S.findAll(b)}function f(a){return a.map(function(a){return j.cancel(a.type.substr(1),a.id)})}function g(a,b){return a.map(function(a){return j.restart(a.type.substr(1),a.id,b)})}function h(a,b,c){var d;return"new"===a&&(a="start"),"remove"===a&&b.cancelledAt&&(a="cancel"),"remove"===a&&b.$processedAt&&(a="success"),"update"===a&&b.$error?(a="error",d=b.$error,delete b.$error,j.trigger("error",d,b,c),j.trigger("error:"+b.type,d,b,c),j.trigger("error:"+b.type+":"+b.id,d,b,c),c=eb.extend({},c,{error:d}),j.trigger("change","error",b,c),j.trigger("change:"+b.type,"error",b,c),j.trigger("change:"+b.type+":"+b.id,"error",b,c),void 0):(("start"===a||"cancel"===a||"success"===a)&&(j.trigger(a,b,c),j.trigger(a+":"+b.type,b,c),"start"!==a&&j.trigger(a+":"+b.type+":"+b.id,b,c),j.trigger("change",a,b,c),j.trigger("change:"+b.type,a,b,c),"start"!==a&&j.trigger("change:"+b.type+":"+b.id,a,b,c)),void 0)}function i(){return JSON.stringify(new Date).replace(/['"]/g,"")}var j=function k(a,b){return tb(k,{type:a,id:b})};return L({context:j,namespace:"task"}),j.start=function(a,c){return V.hasAccount()?S.add("$"+a,c).then(b):V.anonymousSignUp().then(function(){return j.start(a,c)})},j.cancel=function(a,b){return S.update("$"+a,b,{cancelledAt:i()}).then(c)},j.restart=function(a,b,c){var d=function(a){return eb.extend(a,c),delete a.$error,delete a.$processedAt,delete a.cancelledAt,j.start(a.type,a)};return j.cancel(a,b).then(d)},j.cancelAll=function(a){return e(a).then(f)},j.restartAll=function(a,b){return"object"==typeof a&&(b=a),e(a).then(function(a){g(a,b)})},j.subscribeToStoreEvents=function(){a(),delete j.subscribeToStoreEvents},j};var L=require("./events");module.exports=function(a,b){var c=b.type,d=b.id,e={};return d||(L({context:e,namespace:"task:"+c}),e.start=function(b){return a.start(c,b)},e.cancel=function(b){return a.cancel(c,b)},e.restart=function(b,d){return a.restart(c,b,d)},e.cancelAll=function(){return a.cancelAll(c)},e.restartAll=function(b){return a.restartAll(c,b)}),d&&(L({context:e,namespace:"task:"+c+":"+d}),e.cancel=function(){return a.cancel(c,d)},e.restart=function(b){return a.restart(c,d,b)}),e}}(window);