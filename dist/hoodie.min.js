// Hoodie.js - 0.4.0
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

!function(){"use strict";function a(a){for(var b=0;b<u.length;b++)u[b](a)}function b(a){var b="function"==typeof a.done,c="function"!=typeof a.resolve;return!!(a&&b&&c)}function c(){return v.resolve().promise()}function d(){return v.reject().promise()}function e(){return v.resolve.apply(v,arguments).promise()}function f(){return v.reject.apply(v,arguments).promise()}function g(){return x=3e4,z=window.setTimeout(exports.checkConnection,x),exports.isConnected()||(i.trigger("reconnected"),w=!0),j.resolve()}function h(){return x=3e3,z=window.setTimeout(exports.checkConnection,x),exports.isConnected()&&(i.trigger("disconnected"),w=!1),j.reject()}var i=require("./hoodie/events"),j=require("./hoodie/promises"),k=require("./hoodie/request"),l=require("./hoodie/connection"),m=require("./hoodie/uuid"),n=require("./hoodie/dispose"),o=require("./hoodie/open"),p=require("./hoodie/store"),q=require("./hoodie/task"),r=require("./hoodie/config"),s=require("./hoodie/account"),t=require("./hoodie/remote_store"),s=require("./hoodie/account");module.exports=function J(b){var c=this;if(!(c instanceof J))throw new Error("usage: new Hoodie(url);");b&&(this.baseUrl=b.replace(/\/+$/,"")),this.extend=function(a){a(c)},this.bind=i.bind,this.on=i.on,this.one=i.one,this.trigger=i.trigger,this.unbind=i.unbind,this.off=i.off,this.defer=j.defer,this.isPromise=j.isPromise,this.resolve=j.resolve,this.reject=j.reject,this.resolveWith=j.resolveWith,this.request=k,this.isOnline=l.isOnline,this.checkConnection=l.checkConnection,this.UUID=m,this.dispose=n,this.open=o,this.store=p,this.task=q,this.config=r,this.account=s,this.remote=t,this.account.username=r.get("_account.username"),this.account.checkPasswordReset(),i.on("account:signout",r.clear),this.store.patchIfNotPersistant(),this.store.subscribeToOutsideEvents(),this.store.bootstrapDirtyObjects(),this.remote.subscribeToEvents(),this.task.subscribeToStoreEvents(),this.account.authenticate().then(function(){t.connect()}),window.addEventListener("online",this.checkConnection,!1),window.addEventListener("offline",this.checkConnection,!1),this.checkConnection(),a(c)};var u=[];Hoodie.extend=function(a){u.push(a)},module.exports=function(a,b){function c(b,c){var d,e,f,g;for(d=b.split(" "),f=0,g=d.length;g>f;f++)e=h+d[f],a.eventsCallbacks[e]=a.eventsCallbacks[e]||[],a.eventsCallbacks[e].push(c)}function d(a,b){a=h+a;var c=function(){exports.unbind(a,c),b.apply(null,arguments)};exports.bind(a,c)}function e(){var b,c,d,e,f,g;if(b=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=b.shift(),d=h+d,e=a.eventsCallbacks[d]){for(f=0,g=e.length;g>f;f++)c=e[f],c.apply(null,b);return!0}}function f(b,c){var d,e,f,g,i,j;if(!b)return h||(a.eventsCallbacks={}),j=Object.keys(a.eventsCallbacks),j=j.filter(function(a){return 0===a.indexOf(h)}),j.forEach(function(b){delete a.eventsCallbacks[b]}),void 0;if(b=h+b,f=a.eventsCallbacks[b]){if(!c)return delete a.eventsCallbacks[b],void 0;for(e=g=0,i=f.length;i>g;e=++g)if(d=f[e],d===c){f=f.slice(),f.splice(e,1),a.eventsCallbacks[b]=f;break}}}var g=a,h="";return b=b||{},a.eventsCallbacks||(a.eventsCallbacks={}),b.context&&(g=b.context,h=b.namespace+":"),{bind:c,on:c,one:d,trigger:e,unbind:f,off:f}};var v=$.Deferred();module.exports={defer:v,isPromise:b,resolve:c,reject:d,resolveWith:e,rejectWith:f};var j=require("./promises");module.exports=function(){function a(a,f,g){var h,i,j;return g=g||{},h={type:a,dataType:"json"},/^http/.test(f)||(f=(this.baseUrl||"")+e+f),/^http/.test(f)&&(h.xhrFields={withCredentials:!0},h.crossDomain=!0),h.url=f,i=d(c(h,g)),j=i.then(null,b),j.abort=i.abort,j}function b(a){var b;try{b=JSON.parse(a.responseText)}catch(c){b={error:a.responseText||"Cannot connect to Hoodie server at "+(this.baseUrl||"/")}}return j.rejectWith(b).promise()}var c=$.extend,d=$.ajax,e="/_api";return a}();var j=require("./promises"),i=require("./events"),k=require("./request"),w=!0,x=3e4,y=null,z=null,A=function(){var a=y;return a&&"pending"===a.state()?a:(window.clearTimeout(z),y=k("GET","/").then(g,h))},B=function(){return w};module.exports={checkConnection:A,isConnected:B},module.exports=function(a){var b,c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=c.length,e="";for(void 0===a&&(a=7),b=0;a>b;b++){var f=Math.random()*d,g=c[Math.floor(f)];e+=String(g).charAt(0)}return e};var i=require("./events");module.exports=function(){i.trigger("dispose"),i.unbind()};var C=require("./remote_store");module.exports=function(a){function b(b,d){return d=d||{},c(d,{name:b}),C(a,d)}var c=$.extend;return b};var i=require("./events"),D=require("./scoped_store"),E=require("./errors"),F=require("util");module.exports=function(a,b){function c(a){return new RegExp(/^[^\/]+$/).test(a||"")}function d(a){return new RegExp(/^[^\/]+$/).test(a||"")}function e(a){return F.inherits(a,l)}function f(){var b=a.resolveWith.apply(null,arguments);return e(b)}function g(){var b=a.rejectWith.apply(null,arguments);return e(b)}var h=this;this.options=b||{};var j,k={},l={hoodie:a};j=this.options.name?this.options.name:"store";var m=function o(b,c){var d=$.extend(!0,{type:b,id:c},h.options);return D(a,o,d)};if(i({context:m,namespace:j}),m.validate=function(a){return a.id?a?d(a.type)?c(a.id)?void 0:E.INVALID_KEY({id:a.id}):E.INVALID_KEY({type:a.type}):E.INVALID_ARGUMENTS("no object passed"):void 0},m.save=function(a,b,c,d){d=d?$.extend(!0,{},d):{};var f=$.extend(!0,{},c,{type:a,id:b}),h=m.validate(f,d||{});return h?g(h):e(k.save(f,d||{}))},m.add=function(a,b,c){return b=b||{},c=c||{},m.save(a,b.id,b,c)},m.find=function(a,b){return e(k.find(a,b))},m.findOrAdd=function(a,b,c){function d(){var d=$.extend(!0,{id:b},c);return m.add(a,d)}c=c||{};var f=m.find(a,b).then(null,d);return e(f)},m.findAll=function(a,b){return e(k.findAll(a,b))},m.update=function(a,b,c,d){function g(e){var g,h,i;return h=$.extend(!0,{},e),"function"==typeof c&&(c=c(h)),c?(g=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(i=c[b],e[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),g.length||d?m.save(a,b,h,d):f(h)):f(e)}var h=m.find(a,b).then(g);return e(h)},m.updateOrAdd=function(a,b,c,d){function f(){var e=$.extend(!0,{},c,{id:b});return m.add(a,e,d)}var g=m.update(a,b,c,d).then(null,f);return e(g)},m.updateAll=function(b,c,d){var f;switch(d=d||{},!0){case"string"==typeof b:f=m.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=m.findAll()}return f=f.then(function(a){var b,e;return $.isArray(a)||(a=[a]),e=function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)b=a[e],g.push(m.update(b.type,b.id,c,d));return g}(),$.when.apply(null,e)}),e(f)},m.remove=function(a,b,c){return e(k.remove(a,b,c||{}))},m.removeAll=function(a,b){return e(k.removeAll(a,b||{}))},m.decoratePromises=function(a){return F.inherits(l,a)},!b.backend)throw new Error("options.backend must be passed");var n="save find findAll remove removeAll".split(" ");return n.forEach(function(a){if(!b.backend[a])throw new Error("options.backend."+a+" must be passed.");k[a]=b.backend[a]}),m};var i=require("./events");module.exports=function(a,b){var c;c=this.options.name?this.options.name:"store";var d=b.type,e=b.id,f={};return e||(i({context:f,namespace:c+":"+d}),f.save=function(b,c,e){return a.store.save(d,b,c,e)},f.add=function(b,c){return a.store.add(d,b,c)},f.find=function(b){return a.store.find(d,b)},f.findOrAdd=function(b,c){return a.store.findOrAdd(d,b,c)},f.findAll=function(b){return a.store.findAll(d,b)},f.update=function(b,c,e){return a.store.update(d,b,c,e)},f.updateAll=function(b,c){return a.store.updateAll(d,b,c)},f.remove=function(b,c){return a.store.remove(d,b,c)},f.removeAll=function(b){return a.store.removeAll(d,b)}),e&&(i({context:f,namespace:c+":"+d+":"+e}),f.save=function(b,c){return a.store.save(d,e,b,c)},f.find=function(){return a.store.find(d,e)},f.update=function(b,c){return a.store.update(d,e,b,c)},f.remove=function(b){return a.store.remove(d,e,b)}),f.decoratePromises=a.store.decoratePromises,f.validate=a.store.validate,f},module.exports={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}};var G=require("./uuid"),l=require("./connection"),j=require("./promises"),k=require("./request"),H=require("./store");module.exports=function(a,b){function c(a){return"function"==typeof v?v(a):v=a}function d(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==B.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,t.prefix&&(c._id=""+t.prefix+c._id),delete c.id,c}function e(a){var b,c,d;return b=a._id||a.id,delete a._id,t.prefix&&(b=b.replace(new RegExp("^"+t.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function f(a){var b,c,d,f;for(f=[],c=0,d=a.length;d>c;c++)b=a[c],f.push(e(b));return f}function g(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=h(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function h(){return G(9)}function i(a){return a.rows.map(function(a){return a.doc})}function m(){var a;return a=t.getSinceNr(),t.isConnected()&&!w?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function n(){x&&x.abort()}function o(a){return c(a.last_seq),r(a.results),t.isConnected()?t.pull():void 0}function p(a,b){if(t.isConnected())switch(a.status){case 401:return t.trigger("error:unauthenticated",b),t.disconnect();case 404:return window.setTimeout(t.pull,3e3);case 500:return t.trigger("error:server",b),window.setTimeout(t.pull,3e3),l.checkConnection();default:return"abort"===a.statusText?t.pull():(window.setTimeout(t.pull,3e3),l.checkConnection())}}function q(){w=!1,t.trigger("bootstrap:end")}function r(a){var b,c,d,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!t.prefix||0===b._id.indexOf(t.prefix)){if(d=e(b),d._deleted){if(!t.isKnownObject(d))continue;c="remove",t.isKnownObject(d)}else t.isKnownObject(d)?c="update":(c="add",t.markAsKnownObject(d));t.trigger(c,d),t.trigger(c+":"+d.type,d),t.trigger(c+":"+d.type+":"+d.id,d),t.trigger("change",c,d),t.trigger("change:"+d.type,c,d),t.trigger("change:"+d.type+":"+d.id,c,d)}}var s={};s.find=function(a,b){var c;return c=a+"/"+b,t.prefix&&(c=t.prefix+c),c="/"+encodeURIComponent(c),k("GET",c).then(e)},s.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==t.prefix:d=t.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==t.prefix:d=t.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),k("GET",c).then(i).then(f)},s.save=function(a){var b;return a.id||(a.id=G()),a=d(a),b="/"+encodeURIComponent(a._id),k("PUT",b,{data:a})},s.remove=function(a,b){return t.update(a,b,{_deleted:!0})},s.removeAll=function(a){return t.updateAll(a,{_deleted:!0})};var t=H(a,{name:b.name,backend:{save:s.save,find:s.find,findAll:s.findAll,remove:s.remove,removeAll:s.removeAll}}),u=null;t.connected=!1,t.prefix="",void 0!==b.name&&(u=b.name),void 0!==b.prefix&&(t.prefix=b.prefix),null!==b.baseUrl&&(t.baseUrl=b.baseUrl),k=function E(a,b,c){return c=c||{},u&&(b="/"+encodeURIComponent(u)+b),t.baseUrl&&(b=""+t.baseUrl+b),c.contentType=c.contentType||"application/json",("POST"===a||"PUT"===a)&&(c.dataType=c.dataType||"json",c.processData=c.processData||!1,c.data=JSON.stringify(c.data)),E(a,b,c)},t.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==A[b]?A[b]:void 0},t.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return A[b]=1,A[b]},t.connect=function(a){return a&&(u=a),t.connected=!0,t.trigger("connect"),t.bootstrap()},t.disconnect=function(){t.connected=!1,t.trigger("disconnect"),x&&x.abort(),z&&z.abort()},t.isConnected=function(){return t.connected};var v=b.since||0;t.getSinceNr=function(){return"function"==typeof v?v():v};var w=!1;t.bootstrap=function(){return w=!0,t.trigger("bootstrap:start"),t.pull().done(q)};var x,y;t.pull=function(){return x=k("GET",m()),t.isConnected()&&(window.clearTimeout(y),y=window.setTimeout(n,25e3)),x.done(o).fail(p)};var z;t.push=function(a){var b,c,e,f;if($.isArray(a)||(a=C()),0===a.length)return j.resolveWith([]);for(c=[],e=0,f=a.length;f>e;e++)b=$.extend(!0,{},a[e]),g(b),b=d(b),c.push(b);return z=k("POST","/_bulk_docs",{data:{docs:c,new_edits:!1}}),z.done(function(){for(var b=0;b<a.length;b++)t.trigger("push",a[b])}),z},t.sync=function(a){return t.push(a).then(t.pull)};var A={},B=["_id","_rev","_deleted","_revisions","_attachments"],C=function(){return[]};if(b.defaultObjectsToPush&&(C=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var D=0;D<b.knownObjects.length;D++)t.markAsKnownObject({type:b.knownObjects[D].type,id:b.knownObjects[D].id});return t};var G=require("./uuid"),s=require("./account"),j=require("./promises"),i=require("./events"),E=require("./errors"),H=require("./store");module.exports=function(){function a(a){return q(a.type)?arguments.length>0&&!p(a.id)?E.INVALID_KEY({id:a.id}):void 0:E.INVALID_KEY({type:a.type})}function b(a,b,c,d){var g;if(void 0===c&&(c=!1),d=d||{},g=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),l(a,b,c),d.remote)return f(a,b),C[g]=$.extend(!0,{},c),C[g]}else{if(C[g]===!1)return!1;if(C[g])return $.extend(!0,{},C[g]);if(c=m(a,b),c===!1)return f(a,b),C[g]=!1,!1}return u(c)?(e(a,b,c,d),C[g]=!1,!1):(C[g]=$.extend(!0,{},c),t(c)?e(a,b,C[g],d):f(a,b),$.extend(!0,{},c))}function c(){var a,c,d,e,f,g,h;if(c=L.getItem("_dirty"))for(c=c.split(","),f=0,g=c.length;g>f;f++)h=c[f].split("/"),e=h[0],a=h[1],d=b(e,a)}function d(){i.on("account:cleanup",J.clear),i.on("account:signup",g),i.on("remote:bootstrap:start",x),i.on("remote:bootstrap:end",y),i.on("remote:change",h),i.on("remote:push",k)}function e(a,b,c,d){var e;d=d||{},e=""+a+"/"+b,D[e]=c,n(),d.silent||w()}function f(a,b){var c;return a&&b?(c=""+a+"/"+b,delete D[c]):D={},n(),window.clearTimeout(M)}function g(){return J.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,D[b]=c;n(),w()})}function h(a,b){"remove"===a?J.remove(b.type,b.id,{remote:!0}):J.save(b.type,b.id,b,{remote:!0})}function k(a){v("sync",a)}function l(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,L.setItem(d,JSON.stringify(e))}function m(a,b){var c,d;c=""+a+"/"+b;var e=L.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function n(){try{if($.isEmptyObject(D))L.removeItem("_dirty");else{var a=Object.keys(D);L.setItem("_dirty",a.join(","))}}catch(b){}}function o(){return JSON.stringify(new Date).replace(/['"]/g,"")}function p(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)}function q(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)}function r(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)}function t(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function u(a){return a._deleted===!0}function v(a,b,c){J.trigger(a,b,c),J.trigger(""+a+":"+b.type,b,c),"new"!==a&&J.trigger(""+a+":"+b.type+":"+b.id,b,c),"sync"!==a&&(J.trigger("change",a,b,c),J.trigger("change:"+b.type,a,b,c),"new"!==a&&J.trigger("change:"+b.type+":"+b.id,a,b,c))}function w(){J.trigger("dirty"),window.clearTimeout(M),M=window.setTimeout(function(){J.trigger("idle",J.changedObjects())},I)}function x(){K=!0,J.trigger("bootstrap:start")}function y(){var a,b,c,d;for(K=!1;F.length>0;)a=F.shift(),b=a[0],c=a[1],d=a[2],B[b].apply(B,c).then(d.resolve,d.reject);J.trigger("bootstrap:end")}function z(a,b){var c=j.defer();return F.push([a,b,c]),c.promise()}function A(){J.isPersistent()||(L={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var B={},C={},D={},F=[],I=2e3;B.save=function(a,c){var d,e,f,g,h,i;if(c=c||{},J.isBootstrapping())return z("save",arguments);if(a.id?(d=b(a.type,a.id),h="object"!=typeof d):(h=!0,a.id=G()),h?a.createdBy=a.createdBy||s.ownerHash:d.createdBy&&(a.createdBy=d.createdBy),!h)for(i in d)if(!a.hasOwnProperty(i))switch(i.charAt(0)){case"_":c.remote&&(a[i]=d[i]);break;case"$":c.remote||(a[i]=d[i])}c.remote?a._syncedAt=o():c.silent||(a.updatedAt=o(),a.createdAt=a.createdAt||a.updatedAt),c.local?a._$local=!0:delete a._$local,e=j.defer();try{a=b(a.type,a.id,a,c),e.resolve(a,h).promise(),g=h?"add":"update",v(g,a,c)}catch(k){f=k,e.reject(f.toString())}return e.promise()},B.find=function(a,c){var d,e,f;if(d=j.defer(),J.isBootstrapping())return z("find",arguments);try{f=b(a,c),f||d.reject(E.NOT_FOUND(a,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return d.promise()},B.findAll=function(a){var c,d,e,f,g,h,i,k,l;if(null==a&&(a=function(){return!0}),J.isBootstrapping())return z("findAll",arguments);h=J.index(),"string"==typeof a&&(l=a,a=function(a){return a.type===l}),d=j.defer();try{k=function(){var d,e,j,k;for(k=[],d=0,e=h.length;e>d;d++)g=h[d],r(g)&&(j=g.split("/"),c=j[0],f=j[1],i=b(c,f),i&&a(i)&&k.push(i));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(k).promise()}catch(m){e=m,d.reject(e).promise()}return d.promise()},B.remove=function(a,c,d){var e,g,h;return d=d||{},J.isBootstrapping()?z("remove",arguments):(e=a+"/"+c,g=b(a,c),d.remote&&(L.removeItem(e),h=C[e]&&u(C[e]),C[e]=!1,f(a,c),h&&g)?j.resolveWith(g):g?(g._syncedAt?(g._deleted=!0,b(a,c,g)):(e=a+"/"+c,L.removeItem(e),C[e]=!1,f(a,c)),v("remove",g,d),j.resolveWith(g)):j.rejectWith(E.NOT_FOUND(a,c)))},B.removeAll=function(a,b){return J.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(J.remove(c.type,c.id,b));return f})};var J=H({validate:a,backend:{save:B.save,find:B.find,findAll:B.findAll,remove:B.remove,removeAll:B.removeAll}});J.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=L.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=L.key(a),r(b)&&c.push(b);return c},J.changedObjects=function(){var a,b,c,d,e,f,g;e=D,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},J.hasLocalChanges=function(a,c){if(!a)return!$.isEmptyObject(D);var d=[a,c].join("/");return D[d]?!0:t(b(a,c))},J.clear=function(){var a,b,c,d;a=j.defer();try{c=J.index(),d=function(){var a,d,e;for(e=[],a=0,d=c.length;d>a;a++)b=c[a],r(b)&&e.push(L.removeItem(b));return e}.call(this),C={},f(),a.resolve(),J.trigger("clear")}catch(e){a.reject(e)}return a.promise()};var K=!1;J.isBootstrapping=function(){return K},J.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var L={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};J.subscribeToOutsideEvents=function(){d(),delete J.subscribeToOutsideEvents};var M;J=H,J.bootstrapDirtyObjects=function(){c(),delete J.bootstrapDirtyObjects},J.patchIfNotPersistant=function(){A(),delete J.patchIfNotPersistant}};var p=require("./store");module.exports=function(){var a="$config",b="hoodie",c={},d={};return d.set=function(d,e){var f,g;if(c[d]!==e)return c[d]=e,g={},g[d]=e,f="_"===d.charAt(0),p.updateOrAdd(a,b,g,{silent:f})},d.get=function(a){return c[a]},d.clear=function(){return c={},p.remove(a,b)},d.unset=function(a){return d.set(a,void 0)},p.find(a,b).done(function(a){c=a}),d};var i=require("./events"),j=require("./promises"),G=require("./uuid"),r=require("./config"),t=require("./remote_store");module.exports=function(){function a(a){return r.set(M,a)}function b(){return r.get(M)}function c(){return r.unset(M)}function d(a){return I.username!==a?(I.username=a,r.set("_account.username",a)):void 0}function e(a){return I.ownerHash!==a?(I.ownerHash=a,r.set("createdBy",a),r.set("_account.ownerHash",a)):void 0}function f(a){return a.userCtx.name?(H=!0,d(a.userCtx.name.replace(/^user(_anonymous)?\//,"")),e(a.userCtx.roles[0]),j.resolveWith(I.username)):I.hasAnonymousAccount()?I.signIn(I.username,b()):(H=!1,I.trigger("error:unauthenticated"),j.reject())}function g(a){var b;if(a=a||{},a.reason)return j.rejectWith(a);var c=a;try{a=JSON.parse(c.responseText)}catch(d){b=d,a={error:c.responseText||"unknown"}}return j.rejectWith(a)}function h(a,b){return function(c){return I.trigger("signup",a),J._rev=c.rev,k(a,b)}}function k(a,b,c,d){return d||(d=j.defer()),window.setTimeout(function(){var e=E(a,b);e.done(d.resolve),e.fail(function(e){"unconfirmed"===e.error?k(a,b,c,d):d.reject.apply(d,arguments)})},300),d.promise()}function l(a){return a=a||{},function(b){var c,f;return c=j.defer(),f=b.name.replace(/^user(_anonymous)?\//,""),-1!==b.roles.indexOf("error")?(I.fetch(f).fail(c.reject).done(function(){return c.reject({error:"error",reason:J.$error})}),c.promise()):-1===b.roles.indexOf("confirmed")?c.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(d(f),e(b.roles[0]),H=!0,a.silent||a.reauthenticated||(I.hasAnonymousAccount()?I.trigger("signin:anonymous",f):I.trigger("signin",f)),a.reauthenticated&&I.trigger("reauthenticated",f),I.fetch(),c.resolve(f,b.roles[0]))}}function m(a){var b;return b=a.$error?a.$error:{error:"pending"},j.rejectWith(b)}function n(a){return 401===a.status?(r.unset("_account.resetPasswordId"),I.trigger("passwordreset"),j.resolve()):g(a)}function o(a,b,c){return E(I.username,a,{silent:!0}).then(function(){return I.fetch().then(z(a,b,c))})}function p(a,d){var e=b();return o(e,a,d).done(function(){I.trigger("signup",a),c()})}function q(){return t.disconnect(),J._deleted=!0,B("updateUsersDoc",function(){I.request("PUT",y(),{data:JSON.stringify(J),contentType:"application/json"})})}function s(a){return"not_found"===a.error?j.resolve():j.rejectWith(a)}function u(a){return a=a||{},I.trigger("cleanup"),H=a.authenticated,r.clear(),d(a.username),e(a.ownerHash||G()),j.resolve()}function v(){return u().then(function(){return I.trigger("signout")})}function w(a){var b;return b=a===I.ownerHash?"user_anonymous":"user",""+b+"/"+a}function x(a){return a=a||I.username,""+L+":"+w(a)}function y(a){return"/_users/"+encodeURIComponent(x(a))}function z(a,b,c){return function(){var d=$.extend({},J);b&&(d.$newUsername=b),d.updatedAt=F(),d.signedUpAt=d.signedUpAt||F(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return B("updateUsersDoc",function(){return I.request("PUT",y(),e).then(A(b,c||a),g)})}}function A(a,b){return function(){return t.disconnect(),a?k(a,b,{silent:!0}):I.signIn(I.username,b)}}function B(a,b){return void 0!==K[a]&&"function"==typeof K[a].abort&&K[a].abort(),K[a]=b(),K[a]}function C(a,b){return void 0!==K[a]&&"function"==typeof K[a].state&&"pending"===K[a].state()?K[a]:(K[a]=b(),K[a])}function D(){return C("signOut",function(){return I.request("DELETE","/_session").then(null,g)})}function E(a,b,c){var d={data:{name:w(a),password:b}};return B("signIn",function(){var a=I.request("POST","/_session",d);return a.then(l(c),g)})}function F(){return new Date}var H,I={},J={},K={},L="org.couchdb.user";i({context:I,namespace:"account"}),I.authenticate=function(){var a;return H===!1?j.reject():H===!0?j.resolveWith(I.username):K.signOut&&"pending"===K.signOut.state()?K.signOut.then(j.rejectWith):K.signIn&&"pending"===K.signIn.state()?K.signIn:void 0===I.username?D().then(function(){return H=!1,j.reject()}):(a=function(){return I.request("GET","/_session").then(f,g)},C("authenticate",a))},I.signUp=function(a,b){if(void 0===b&&(b=""),!a)return j.rejectWith({error:"username must be set"});if(I.hasAnonymousAccount())return p(a,b);if(I.hasAccount())return j.rejectWith({error:"you have to sign out first"});a=a.toLowerCase();var c={data:JSON.stringify({_id:x(a),name:w(a),type:"user",roles:[],password:b,ownerHash:I.ownerHash,database:I.db(),updatedAt:F(),createdAt:F(),signedUpAt:a!==I.ownerHash?F():void 0}),contentType:"application/json"};return I.request("PUT",y(a),c).then(h(a,b),g)},I.anonymousSignUp=function(){var b=G(10),c=I.ownerHash;return I.signUp(c,b).done(function(){return a(b),I.trigger("signup:anonymous",c)})},I.hasAccount=function(){return!!I.username},I.hasAnonymousAccount=function(){return void 0!==b()};var M="_account.anonymousPassword";return I.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==I.username?I.signOut({silent:!0}).then(function(){return E(a,b)}):E(a,b,{reauthenticated:!0})},I.signOut=function(a){return a=a||{},I.hasAccount()?(t.disconnect(),D().then(v)):u().then(function(){return a.silent?void 0:I.trigger("signout")})},I.request=function N(a,b,c){return c=c||{},N.apply(arguments)},I.db=function(){return"user/"+I.ownerHash},I.fetch=function(a){return void 0===a&&(a=I.username),a?C("fetch",function(){return I.request("GET",y(a)).then(null,g).done(function(a){return J=a})}):j.rejectWith({error:"unauthenticated",reason:"not logged in"})},I.changePassword=function(a,b){return I.username?(t.disconnect(),I.fetch().then(z(a,null,b),g)):j.rejectWith({error:"unauthenticated",reason:"not logged in"})},I.resetPassword=function(a){var b,c,d,e;return(e=r.get("_account.resetPasswordId"))?I.checkPasswordReset():(e=""+a+"/"+G(),r.set("_account.resetPasswordId",e),c=""+L+":$passwordReset/"+e,b={_id:c,name:"$passwordReset/"+e,type:"user",roles:[],password:e,createdAt:F(),updatedAt:F()},d={data:JSON.stringify(b),contentType:"application/json"},B("resetPassword",function(){return I.request("PUT","/_users/"+encodeURIComponent(c),d).then(null,g).done(I.checkPasswordReset)}))},I.checkPasswordReset=function(){var a,b,c,d,e;return(c=r.get("_account.resetPasswordId"))?(e="$passwordReset/"+c,d="/_users/"+encodeURIComponent(L+":"+e),a=btoa(e+":"+c),b={headers:{Authorization:"Basic "+a}},B("passwordResetStatus",function(){return I.request("GET",d,b).then(m,n).fail(function(a){return"pending"===a.error?(window.setTimeout(I.checkPasswordReset,1e3),void 0):I.trigger("password_reset:error")})})):j.rejectWith({error:"missing"})},I.changeUsername=function(a,b){return b=b||"",o(a,b.toLowerCase())},I.destroy=function(){return I.hasAccount()?I.fetch().then(q,s).then(v):v()},I.ownerHash=r.get("_account.ownerHash"),I.ownerHash||e(G()),I};var o=require("./open"),s=require("./account"),p=require("./store"),i=require("./events"),r=require("./config");module.exports=function(){function a(a){return a?r.set("_remote.since",a):r.get("_remote.since")||0}function b(){i.on("remote:connect",function(){i.on("store:idle",c.push),c.push()}),i.on("remote:disconnect",function(){i.unbind("store:idle",c.push)}),i.on("disconnected",c.disconnect),i.on("reconnected",c.connect),i.on("account:signin",function(){c.connect(s.db())}),i.on("account:reauthenticated",c.connect),i.on("account:signout",c.disconnect)}var c=o(s.db(),{connected:!0,prefix:"",since:a,defaultObjectsToPush:p.changedObjects,knownObjects:p.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})});return c.trigger=function(){var a;a=arguments[0];var b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return i.trigger.apply(["remote:"+a].concat(Array.prototype.slice.call(b)))},c.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),i.on(a,b)},c.unbind=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),i.unbind(a,b)},c.subscribeToEvents=function(){b(),delete c.subscribeToEvents},c};var i=require("./events"),j=require("./promises"),I=require("./scoped_task"),s=require("./account"),p=require("./store");module.exports=function(){function a(){i.on("store:change",d)}function b(a){var b=j.defer(),c=p(a.type,a.id);return c.on("remove",function(a){return a.type=a.type.substr(1),a.finishedAt?b.resolve(a):(b.reject(a),void 0)}),c.on("error",function(a,c){c.type=c.type.substr(1),b.reject(a,c)}),b.promise()}function c(a){var b,c="$"+a.type,d=a.id,e=p.remove(c,d);return a._rev?(b=j.defer(),i.one("store:sync:"+c+":"+d,b.resolve),e.fail(b.reject),b.promise()):e}function d(a,b,c){"$"===b.type[0]&&(b.type=b.type.substr(1),h(a,b,c))}function e(a){var b,c="$";return a&&(c+=a),b=function(a){return 0===a.type.indexOf(c)},p.findAll(b)}function f(a){return a.map(function(a){return l.cancel(a.type.substr(1),a.id)})}function g(a,b){return a.map(function(a){return l.restart(a.type.substr(1),a.id,b)})}function h(a,b,c){var d;return"new"===a&&(a="start"),"remove"===a&&b.cancelledAt&&(a="cancel"),"remove"===a&&b.$processedAt&&(a="success"),"update"===a&&b.$error?(a="error",d=b.$error,delete b.$error,l.trigger("error",d,b,c),l.trigger("error:"+b.type,d,b,c),l.trigger("error:"+b.type+":"+b.id,d,b,c),c=$.extend({},c,{error:d}),l.trigger("change","error",b,c),l.trigger("change:"+b.type,"error",b,c),l.trigger("change:"+b.type+":"+b.id,"error",b,c),void 0):(("start"===a||"cancel"===a||"success"===a)&&(l.trigger(a,b,c),l.trigger(a+":"+b.type,b,c),"start"!==a&&l.trigger(a+":"+b.type+":"+b.id,b,c),l.trigger("change",a,b,c),l.trigger("change:"+b.type,a,b,c),"start"!==a&&l.trigger("change:"+b.type+":"+b.id,a,b,c)),void 0)}function k(){return JSON.stringify(new Date).replace(/['"]/g,"")}var l=function m(a,b){return I(m,{type:a,id:b})};return i({context:l,namespace:"task"}),l.start=function(a,c){return s.hasAccount()?p.add("$"+a,c).then(b):s.anonymousSignUp().then(function(){return l.start(a,c)})},l.cancel=function(a,b){return p.update("$"+a,b,{cancelledAt:k()}).then(c)},l.restart=function(a,b,c){var d=function(a){return $.extend(a,c),delete a.$error,delete a.$processedAt,delete a.cancelledAt,l.start(a.type,a)};return l.cancel(a,b).then(d)},l.cancelAll=function(a){return e(a).then(f)},l.restartAll=function(a,b){return"object"==typeof a&&(b=a),e(a).then(function(a){g(a,b)})},l.subscribeToStoreEvents=function(){a(),delete l.subscribeToStoreEvents},l};var i=require("./events");module.exports=function(a,b,c){var d=c.type,e=c.id,f={};return e||(i({context:f,namespace:"task:"+d}),f.start=function(a){return b.start(d,a)},f.cancel=function(a){return b.cancel(d,a)},f.restart=function(a,c){return b.restart(d,a,c)},f.cancelAll=function(){return b.cancelAll(d)},f.restartAll=function(a){return b.restartAll(d,a)}),e&&(i({context:f,namespace:"task:"+d+":"+e}),f.cancel=function(){return b.cancel(d,e)},f.restart=function(a){return b.restart(d,e,a)}),f}}(window);